<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>여기서 만나요!</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-70115574-2"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-70115574-2');
    </script>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHV8YUCmlucmnBePRFg9VnhwsGzE3ui_k&callback=initMap&libraries=places&v=weekly"
      defer
    ></script>
    <style type="text/css">
      a:link { color: black; text-decoration: none;}
      a:visited { color: black; text-decoration: none;}
      a:hover { color: blue; text-decoration: underline;}
     
      #map {
        height: 60vh;
        margin: 0px 20px;
      }

      html,
      body {
        height: 90vh;
        margin: 20px;
      }

      #pac-input {
        background-color: #fff;
        font-size: 16px;
        margin-left: 8px;
        margin-top: 20px;
        text-overflow: ellipsis;
      }

      #pac-input:focus {
        border-color: #4d90fe;
      }

      .meetBtn {
        font-style: italic;
      }
    </style>

    <script>
      let map, infoWindow, result;
      result = false;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 37.53, lng: 127.0016985 },
          zoom: 13,
          streetViewControl: true,
          streetViewControlOptions: {
            position: google.maps.ControlPosition.LEFT_BOTTOM,
          },
          fullscreenControl: false,
          mapTypeControl: false,
        });


        infoWindow = new google.maps.InfoWindow();

        // 이름 재정의창
        const name = document.getElementById("nameofMarker");
        name.style.width = "13vw";
        name.style.fontSize = "15pt";
        name.style.marginTop = "20px";
        name.style.marginLeft = "5px";
        name.style.border = "2px solid #000000";
        name.style.borderRadius = "3px";
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(name);

        // 검색창
        const input = document.getElementById("pac-input");
        input.style.fontSize = "14pt";
        input.style.width = "23vw";
        input.style.border = "2px solid #000000";
        input.style.borderRadius = "3px";
        const searchBox = new google.maps.places.SearchBox(input);
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
        
        // 만나요! 버튼
        const meetButton = document.createElement("button");
        meetButton.textContent = "만나요!";
        meetButton.style.fontSize = "14pt";
        meetButton.style.width = "110px";
        meetButton.style.marginRight = "8px";
        meetButton.style.marginTop = "20px";
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(meetButton);

        // 새로 하기 버튼
        const newButton = document.createElement("button");
        newButton.textContent = "새로 하기";
        newButton.style.fontSize = "14pt";
        newButton.style.width = "110px";
        newButton.style.marginRight = "8px";
        newButton.style.marginTop = "10px";
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(newButton);

        // 현재 위치 버튼
        const locationButton = document.createElement("button");
        locationButton.textContent = "현재 위치";
        locationButton.style.fontSize = "14pt";
        locationButton.style.width = "110px";
        locationButton.style.marginTop = "10px";
        locationButton.style.marginRight = "8px";
        locationButton.classList.add("custom-map-control-button");
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(locationButton);

        // pac 검색창 기능
        // Bias the SearchBox results towards current map's viewport.
        map.addListener("bounds_changed", () => {
          searchBox.setBounds(map.getBounds());
        });
        let markers = [];
        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        searchBox.addListener("places_changed", () => {
          if (result == true){
            alert("이미 결과가 있습니다.\n새로 하기 버튼을 눌러주세요.");
            return;
          }
          const places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }
          // For each place, get the icon, name and location.
          const bounds = new google.maps.LatLngBounds();
          places.forEach((place) => {
            if (!place.geometry) {
              console.log("Returned place contains no geometry");
              return;
            }
            // Create a marker for each place.
            let labelname;
            if (document.getElementById("nameofMarker").value == ""){
              labelname = document.getElementById("pac-input").value;
              document.getElementById("pac-input").value = "";
            }
            else{
              labelname = document.getElementById("nameofMarker").value;
              document.getElementById("nameofMarker").value = "";
            }
            markers.push(
              new google.maps.Marker({
                map,
                title: place.name,
                label: labelname,
                position: place.geometry.location,
              })
            );

            if (place.geometry.viewport) {
              // Only geocodes have viewport.
              bounds.union(place.geometry.viewport);
            } else {
              bounds.extend(place.geometry.location);
            }
          });
          map.fitBounds(bounds);
        });

        // 현재 위치 버튼 클릭 이벤트
        locationButton.addEventListener("click", () => {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                // infoWindow.setPosition(pos);
                // infoWindow.open(map);
                map.setCenter(pos);
                map.setZoom(15);
                },
                () => {
                handleLocationError(true, infoWindow, map.getCenter());
                }
            );
            } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
            }
        });

        // 새로 하기 버튼 클릭 이벤트
        newButton.addEventListener("click", () => {
          markers.forEach((marker) => {
            marker.setMap(null);
          });
          markers = [];
          result = false;
          document.getElementById("pac-input").value = "";
          document.getElementById("nameofMarker").value = "";
        })

        // 만나요 버튼 클릭 이벤트
        meetButton.addEventListener("click", () => {
          if (markers == null || markers.length < 2){
            alert("장소를 두 곳 이상 선택해야 합니다!");
            return;
          }
          if (result == true){
            alert("이미 결과가 있습니다.\n새로 하기 버튼을 눌러주세요.");
            return;
          }
          let sumLat = 0.0;
          let sumLng = 0.0;

          for (var i = 0; i < markers.length; i++){
            sumLat += markers[i].position.lat();
            sumLng += markers[i].position.lng();
          }
          const image = "https://raw.githubusercontent.com/icaros7/Meet-Here/google/resource/marker.png"
          markers.push(
            new google.maps.Marker({
              map: map,
              position: { lat: parseFloat(sumLat) / Number(markers.length), lng: parseFloat(sumLng) / Number(markers.length) },
              icon: image,
              animation: google.maps.Animation.DROP,
            })
          );

          var bounds = new google.maps.LatLngBounds();
          for (var i = 0; i < markers.length; i++) {
             bounds.extend(markers[i]);
          }
          map.fitBounds(bounds);

          document.getElementById("pac-input").value = "";
          document.getElementById("nameofMarker").value = "";
          result = true;
        })

        // 검색창 클릭 이벤트
        input.addEventListener("click", () => {
          if (result == true){
            alert("이미 결과가 있습니다.\n새로 하기 버튼을 눌러주세요.");
            return;
          }
        })

        // 이름 재정의 클릭 이벤트
        name.addEventListener("click", () => {
          if (result == true){
            alert("이미 결과가 있습니다.\n새로 하기 버튼을 눌러주세요.");
            return;
          }
        })

        // 지도 클릭 이벤트
        google.maps.event.addListener(map, 'click', function(event) {
          if (result == true){
            alert("이미 결과가 있습니다.\n새로 하기 버튼을 눌러주세요.");
            return;
          }
          let labelname;
          if (document.getElementById("nameofMarker").value == ""){
            labelname = String(markers.length + 1);
          }
          else{
            labelname = document.getElementById("nameofMarker").value;
            document.getElementById("nameofMarker").value = "";
          }
          markers.push(
            new google.maps.Marker({
              position: event.latLng, 
              map: map,
              label: labelname
            })
          );
          document.getElementById("pac-input").value = "";
          document.getElementById("pac-input").value = "";

        });
      }
    </script>
  </head>

  <body>
    <div style="padding-left: 20px;">
      <h1><a href="https://meet.minnote.net">여기서 만나요!</a></h1>
      <h4>알송달송한 우리들 위치의 중심점. 약속 장소 어디가 공평할까?</h4>
      <h4>마우스 클릭 혹은 검색을 통해 위치를 지정 한 뒤 우측 상단 <span class="meetBtn">"만나요!"</span> 버튼을 누르시면 중앙 지점이 표시됩니다.</h4>
      마커의 이름을 바꾸고 싶은 경우 마커 이름 란을 바꾸면 됩니다. 기본 값은 숫자, 검색 키워드 입니다.
      <hr>
    </div>

    <input
      id="nameofMarker"
      class="controls"
      placeholder="마커 이름"
      type="text"
      tabindex="1"
    />
    <input
      id="pac-input"
      class="controls"
      type="text"
      placeholder="장소 검색"
      tabindex="2"
      autofocus
    />
    <div id="map"></div>

    <div style="padding-left: 20px;">
      <h4>Powered By iCAROS7(<a href="https://minnote.net" target="_blank">minnote.net</a>) / Google Map</h4>
      <h5>Version 2.0 (2021.01.19 15:41)</h5>
    </div>
  </body>
</html>
